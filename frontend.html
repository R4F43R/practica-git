<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Cotizaciones y Pedidos - Frontend</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding-bottom: 60px;
    }
    .container {
      max-width: 1100px;
      margin-top: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    .nav-tabs .nav-link.active {
      background-color: #0d6efd !important;
      color: white !important;
    }
    .file-list {
      list-style-type: none;
      padding-left: 0;
    }
    .file-list li {
      background: #e9ecef;
      border-radius: 4px;
      padding: 4px 8px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    .badge-status {
      font-weight: 600;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1080;
    }
    .form-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
    }
    .comment-box {
      resize: vertical;
    }
    #messagesContainer {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      background: #f1f3f5;
      margin-bottom: 15px;
    }
    #messagesContainer .message {
      margin-bottom: 10px;
      padding: 6px 10px;
      border-radius: 4px;
    }
    #messagesContainer .message.client {
      background-color: #d1e7dd;
      align-self: flex-start;
    }
    #messagesContainer .message.company {
      background-color: #cfe2ff;
      align-self: flex-end;
    }
    @media (max-width: 576px) {
      .nav-tabs {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer" style="display:none;">
    <h1 class="text-center mt-3 mb-4">Gestión de Cotizaciones y Pedidos</h1>
    <ul class="nav nav-tabs" id="roleTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="client-tab"
          data-bs-toggle="tab"
          data-bs-target="#client"
          type="button"
          role="tab"
          aria-controls="client"
          aria-selected="true"
        >
          Cliente
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="company-tab"
          data-bs-toggle="tab"
          data-bs-target="#company"
          type="button"
          role="tab"
          aria-controls="company"
          aria-selected="false"
        >
          Empresa
        </button>
      </li>
    </ul>
    <div class="tab-content mt-4" id="roleTabContent">
      <!-- CLIENTE VIEW -->
      <div
        class="tab-pane fade show active"
        id="client"
        role="tabpanel"
        aria-labelledby="client-tab"
      >
        <ul class="nav nav-pills mb-3" id="clientSubTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="quoteRequest-tab"
              data-bs-toggle="pill"
              data-bs-target="#quoteRequest"
              type="button"
              role="tab"
              aria-controls="quoteRequest"
              aria-selected="true"
            >
              Solicitar Cotización
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="myQuotes-tab"
              data-bs-toggle="pill"
              data-bs-target="#myQuotes"
              type="button"
              role="tab"
              aria-controls="myQuotes"
              aria-selected="false"
            >
              Mis Cotizaciones y Pedidos
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="profile-tab"
              data-bs-toggle="pill"
              data-bs-target="#profile"
              type="button"
              role="tab"
              aria-controls="profile"
              aria-selected="false"
            >
              Perfil
            </button>
          </li>
        </ul>
        <div class="tab-content" id="clientSubTabContent">
          <!-- Solicitar Cotización -->
          <div
            class="tab-pane fade show active form-section"
            id="quoteRequest"
            role="tabpanel"
            aria-labelledby="quoteRequest-tab"
          >
            <h2>Solicitar Cotización</h2>
            <form id="formQuoteRequest" novalidate>
              <div class="mb-3">
                <label for="description" class="form-label"
                  >Descripción del trabajo/producto<span class="text-danger">*</span></label
                >
                <textarea
                  class="form-control"
                  id="description"
                  name="description"
                  rows="3"
                  required
                  placeholder="Describa el trabajo o producto deseado"
                ></textarea>
                <div class="invalid-feedback">La descripción es obligatoria.</div>
              </div>
              <div class="mb-3">
                <label for="files" class="form-label">Archivos adjuntos</label>
                <input
                  class="form-control"
                  type="file"
                  id="files"
                  name="files"
                  multiple
                  accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                />
                <small class="form-text text-muted"
                  >Formatos permitidos: imágenes, documentos.</small
                >
                <ul id="fileList" class="file-list mt-2"></ul>
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-4">
                  <label for="quantity" class="form-label"
                    >Cantidad<span class="text-danger">*</span></label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="quantity"
                    name="quantity"
                    min="1"
                    required
                  />
                  <div class="invalid-feedback">Cantidad válida requerida.</div>
                </div>
                <div class="col-md-4">
                  <label for="measurements" class="form-label">Medidas</label>
                  <input
                    type="text"
                    class="form-control"
                    id="measurements"
                    name="measurements"
                    placeholder="Ej: 20x30 cm"
                  />
                </div>
                <div class="col-md-4">
                  <label for="material" class="form-label">Material</label>
                  <input
                    type="text"
                    class="form-control"
                    id="material"
                    name="material"
                    placeholder="Ej: Madera, acero"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="deadline" class="form-label">Fecha límite</label>
                <input
                  type="date"
                  class="form-control"
                  id="deadline"
                  name="deadline"
                  min=""
                />
              </div>
              <h4>Información de contacto</h4>
              <div class="mb-3">
                <label for="clientName" class="form-label"
                  >Nombre completo<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="clientName"
                  name="clientName"
                  required
                />
                <div class="invalid-feedback">El nombre es obligatorio.</div>
              </div>
              <div class="mb-3">
                <label for="clientPhone" class="form-label"
                  >Teléfono<span class="text-danger">*</span></label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="clientPhone"
                  name="clientPhone"
                  required
                  pattern="[\d\s\+\-]{6,20}"
                  placeholder="+54 11 1234-5678"
                />
                <div class="invalid-feedback">
                  Teléfono válido es obligatorio (6 a 20 dígitos).
                </div>
              </div>
              <div class="mb-3">
                <label for="clientEmail" class="form-label"
                  >Correo electrónico<span class="text-danger">*</span></label
                >
                <input
                  type="email"
                  class="form-control"
                  id="clientEmail"
                  name="clientEmail"
                  required
                  readonly
                />
                <div class="invalid-feedback">Correo válido obligatorio.</div>
              </div>
              <button type="submit" class="btn btn-primary">
                Enviar Solicitud
              </button>
            </form>
          </div>

          <!-- Mis Cotizaciones y Pedidos -->
          <div
            class="tab-pane fade form-section"
            id="myQuotes"
            role="tabpanel"
            aria-labelledby="myQuotes-tab"
          >
            <h2>Mis Cotizaciones y Pedidos</h2>
            <div id="clientQuotesContainer">
              <!-- Quotes and Orders list rendered here -->
            </div>
          </div>

          <!-- Perfil -->
          <div
            class="tab-pane fade form-section"
            id="profile"
            role="tabpanel"
            aria-labelledby="profile-tab"
          >
            <h2>Perfil de Usuario</h2>
            <form id="formProfile" novalidate>
              <div class="mb-3">
                <label for="profileName" class="form-label"
                  >Nombre completo<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="profileName"
                  name="profileName"
                  required
                />
                <div class="invalid-feedback">El nombre es obligatorio.</div>
              </div>
              <div class="mb-3">
                <label for="profilePhone" class="form-label"
                  >Teléfono<span class="text-danger">*</span></label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="profilePhone"
                  name="profilePhone"
                  required
                  pattern="[\d\s\+\-]{6,20}"
                />
                <div class="invalid-feedback">
                  Teléfono válido es obligatorio (6 a 20 dígitos).
                </div>
              </div>
              <div class="mb-3">
                <label for="profileEmail" class="form-label"
                  >Correo electrónico<span class="text-danger">*</span></label
                >
                <input
                  type="email"
                  class="form-control"
                  id="profileEmail"
                  name="profileEmail"
                  required
                  readonly
                />
                <div class="invalid-feedback">Correo válido obligatorio.</div>
              </div>
              <button type="submit" class="btn btn-success">
                Guardar Cambios
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- EMPRESA VIEW -->
      <div
        class="tab-pane fade"
        id="company"
        role="tabpanel"
        aria-labelledby="company-tab"
      >
        <ul class="nav nav-pills mb-3" id="companySubTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="manageQuotes-tab"
              data-bs-toggle="pill"
              data-bs-target="#manageQuotes"
              type="button"
              role="tab"
              aria-controls="manageQuotes"
              aria-selected="true"
            >
              Gestionar Cotizaciones
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="manageOrders-tab"
              data-bs-toggle="pill"
              data-bs-target="#manageOrders"
              type="button"
              role="tab"
              aria-controls="manageOrders"
              aria-selected="false"
            >
              Gestión de Pedidos
            </button>
          </li>
        </ul>
        <div class="tab-content" id="companySubTabContent">
          <!-- Gestionar Cotizaciones -->
          <div
            class="tab-pane fade show active form-section"
            id="manageQuotes"
            role="tabpanel"
            aria-labelledby="manageQuotes-tab"
          >
            <h2>Gestionar Cotizaciones</h2>
            <div id="companyQuotesList" class="list-group mb-3">
              <!-- List of quotes here -->
            </div>
            <div id="companyQuoteDetail" style="display:none;">
              <h4>Detalle de Cotización</h4>
              <div id="quoteDetailContent" class="mb-3"></div>
              <form id="formSendQuote" novalidate>
                <div class="mb-3">
                  <label for="quoteDescription" class="form-label"
                    >Descripción de Servicios/Productos<span class="text-danger">*</span></label
                  >
                  <textarea
                    id="quoteDescription"
                    class="form-control"
                    rows="3"
                    required
                  ></textarea>
                  <div class="invalid-feedback">
                    La descripción de la cotización es obligatoria.
                  </div>
                </div>
                <div class="mb-3">
                  <label for="unitPrice" class="form-label"
                    >Precio unitario<span class="text-danger">*</span></label
                  >
                  <input
                    type="number"
                    id="unitPrice"
                    class="form-control"
                    min="0"
                    step="any"
                    required
                  />
                  <div class="invalid-feedback">Precio válido obligatorio.</div>
                </div>
                <div class="mb-3">
                  <label for="discount" class="form-label">Descuento (%)</label>
                  <input
                    type="number"
                    id="discount"
                    class="form-control"
                    min="0"
                    max="100"
                    step="any"
                    value="0"
                  />
                </div>
                <div class="mb-3">
                  <label for="tax" class="form-label">Impuestos (%)</label>
                  <input
                    type="number"
                    id="tax"
                    class="form-control"
                    min="0"
                    max="100"
                    step="any"
                    value="0"
                  />
                </div>
                <div class="mb-3">
                  <label for="pdfFile" class="form-label">Adjuntar PDF</label>
                  <input
                    type="file"
                    id="pdfFile"
                    accept="application/pdf"
                    class="form-control"
                  />
                </div>
                <div class="mb-3">
                  <label for="quoteComments" class="form-label">
                    Comentarios para el cliente
                  </label>
                  <textarea id="quoteComments" class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label for="quoteStatus" class="form-label">Estado de la cotización</label>
                  <select id="quoteStatus" class="form-select">
                    <option value="enviada">Enviada</option>
                    <option value="aprobada">Aprobada</option>
                    <option value="rechazada">Rechazada</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary me-2">Guardar</button>
                <button type="button" id="btnBackToQuotes" class="btn btn-secondary">
                  Volver a Cotizaciones
                </button>
              </form>
              <hr />
              <h5>Mensajería con el cliente</h5>
              <div id="messagesContainer" class="d-flex flex-column mb-3"></div>
              <form id="formCompanyMessage">
                <div class="input-group">
                  <input
                    type="text"
                    id="messageInput"
                    class="form-control"
                    placeholder="Escribe un mensaje..."
                    required
                  />
                  <button class="btn btn-outline-primary" type="submit">Enviar</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Gestión de Pedidos -->
          <div
            class="tab-pane fade form-section"
            id="manageOrders"
            role="tabpanel"
            aria-labelledby="manageOrders-tab"
          >
            <h2>Gestión de Pedidos</h2>
            <div id="companyOrdersList" class="list-group mb-3">
              <!-- List of orders here -->
            </div>
            <div id="companyOrderDetail" style="display:none;">
              <h4>Detalle de Pedido</h4>
              <div id="orderDetailContent" class="mb-3"></div>
              <form id="formUpdateOrder" novalidate>
                <div class="mb-3">
                  <label for="orderStatus" class="form-label">Estado del pedido</label>
                  <select id="orderStatus" class="form-select">
                    <option value="pendiente">Pendiente de aprobación</option>
                    <option value="en_produccion">En producción</option>
                    <option value="listo_para_recoger">Listo para recoger</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="responsible" class="form-label">Responsable</label>
                  <input
                    type="text"
                    id="responsible"
                    class="form-control"
                    placeholder="Asignar responsable"
                  />
                </div>
                <button type="submit" class="btn btn-primary me-2">Actualizar</button>
                <button type="button" id="btnBackToOrders" class="btn btn-secondary">
                  Volver a Pedidos
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button id="btnLogout" class="btn btn-danger mt-4">Cerrar Sesión</button>
  </div>

  <!-- Login Form -->
  <div class="container" id="loginContainer">
    <h1 class="text-center mt-5 mb-4">Iniciar Sesión</h1>
    <div class="row justify-content-center">
      <div class="col-md-5">
        <form id="formLogin" novalidate>
          <div class="mb-3">
            <label for="loginEmail" class="form-label">Correo electrónico</label>
            <input type="email" class="form-control" id="loginEmail" required />
            <div class="invalid-feedback">Correo válido obligatorio.</div>
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="loginPassword" required />
            <div class="invalid-feedback">Contraseña obligatoria.</div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
        </form>
        <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    (function () {
      const API_BASE = 'http://localhost:4000';

      // Cached elements
      const loginContainer = document.getElementById('loginContainer');
      const appContainer = document.getElementById('appContainer');
      const formLogin = document.getElementById('formLogin');
      const loginError = document.getElementById('loginError');
      const btnLogout = document.getElementById('btnLogout');

      // Client elements
      const formQuoteRequest = document.getElementById('formQuoteRequest');
      const fileInput = document.getElementById('files');
      const fileListElem = document.getElementById('fileList');
      const clientQuotesContainer = document.getElementById('clientQuotesContainer');
      const clientEmailInput = document.getElementById('clientEmail');
      const clientNameInput = document.getElementById('clientName');
      const clientPhoneInput = document.getElementById('clientPhone');

      const profileForm = document.getElementById('formProfile');
      const profileNameInput = document.getElementById('profileName');
      const profilePhoneInput = document.getElementById('profilePhone');
      const profileEmailInput = document.getElementById('profileEmail');

      // Company elements
      const companyQuotesList = document.getElementById('companyQuotesList');
      const companyQuoteDetail = document.getElementById('companyQuoteDetail');
      const quoteDetailContent = document.getElementById('quoteDetailContent');
      const formSendQuote = document.getElementById('formSendQuote');
      const btnBackToQuotes = document.getElementById('btnBackToQuotes');
      const messagesContainer = document.getElementById('messagesContainer');
      const formCompanyMessage = document.getElementById('formCompanyMessage');
      const messageInput = document.getElementById('messageInput');

      const companyOrdersList = document.getElementById('companyOrdersList');
      const companyOrderDetail = document.getElementById('companyOrderDetail');
      const orderDetailContent = document.getElementById('orderDetailContent');
      const formUpdateOrder = document.getElementById('formUpdateOrder');
      const btnBackToOrders = document.getElementById('btnBackToOrders');

      // Authentication state
      let authToken = null;
      let currentUser = null;
      let currentQuoteId = null;
      let currentOrderQuoteId = null;

      // Utilities
      function showToast(message, type = 'info', delay = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        const toastElem = document.createElement('div');
        toastElem.classList.add(
          'toast',
          'align-items-center',
          'text-bg-' + (type === 'error' ? 'danger' : type),
          'border-0'
        );
        toastElem.id = toastId;
        toastElem.setAttribute('role', 'alert');
        toastElem.setAttribute('aria-live', 'assertive');
        toastElem.setAttribute('aria-atomic', 'true');
        toastElem.innerHTML = `\`
          <div class="d-flex">
            <div class="toast-body">\${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        \`;
        toastContainer.appendChild(toastElem);
        const bsToast = new bootstrap.Toast(toastElem, { delay });
        bsToast.show();
        toastElem.addEventListener('hidden.bs.toast', () => {
          toastElem.remove();
        });
      }

      function setAuth(token, user) {
        authToken = token;
        currentUser = user;
        if(token && user) {
          loginContainer.style.display = 'none';
          appContainer.style.display = '';
          updateUIByRole();
          loadProfile();
          if(user.role === 'client') {
            loadClientQuotes();
          } else if (user.role === 'company') {
            loadCompanyQuotes();
            loadCompanyOrders();
          }
        } else {
          loginContainer.style.display = '';
          appContainer.style.display = 'none';
        }
      }

      function getAuthHeaders() {
        return {
          Authorization: 'Basic ' + authToken,
          'Content-Type': 'application/json',
        };
      }

      async function apiFetch(url, options = {}) {
        options.headers = options.headers || {};
        Object.assign(options.headers, getAuthHeaders());
        const res = await fetch(API_BASE + url, options);
        if (!res.ok) {
          let errorText = 'Error en la solicitud';
          try {
            const errorJson = await res.json();
            if (errorJson.error) errorText = errorJson.error;
          } catch {}
          throw new Error(errorText);
        }
        return res.json();
      }

      // Login form submit
      formLogin.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!formLogin.checkValidity()) {
          formLogin.classList.add('was-validated');
          return;
        }
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        loginError.classList.add('d-none');
        try {
          const res = await fetch(API_BASE + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });
          if (!res.ok) throw new Error('Credenciales inválidas');
          const data = await res.json();
          setAuth(data.token, data);
          formLogin.reset();
          formLogin.classList.remove('was-validated');
        } catch (err) {
          loginError.textContent = err.message;
          loginError.classList.remove('d-none');
        }
      });

      // Logout button
      btnLogout.addEventListener('click', () => {
        authToken = null;
        currentUser = null;
        setAuth(null, null);
      });

      // Disable role tabs based on user role
      function updateUIByRole() {
        const clientTab = document.getElementById('client-tab');
        const companyTab = document.getElementById('company-tab');
        if(currentUser.role === 'client') {
          clientTab.classList.add('active');
          companyTab.classList.remove('active');
          companyTab.setAttribute('disabled', 'true');
          companyTab.setAttribute('aria-disabled', 'true');
          document.getElementById('company').classList.remove('show','active');
          document.getElementById('client').classList.add('show','active');
        } else if(currentUser.role === 'company') {
          companyTab.classList.add('active');
          clientTab.classList.remove('active');
          clientTab.setAttribute('disabled', 'true');
          clientTab.setAttribute('aria-disabled', 'true');
          document.getElementById('client').classList.remove('show','active');
          document.getElementById('company').classList.add('show','active');
        }
        // Fill client email in quote request form readonly
        clientEmailInput.value = currentUser.email;
        profileEmailInput.value = currentUser.email;
      }

      // Set min date for deadline input
      function setMinDateForDeadlines() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('deadline').setAttribute('min', today);
      }
      setMinDateForDeadlines();

      // Handle file input and display file names
      fileInput.addEventListener('change', () => {
        fileListElem.innerHTML = '';
        for(const file of fileInput.files) {
          const li = document.createElement('li');
          li.textContent = file.name;
          fileListElem.appendChild(li);
        }
      });

      // Upload files helper
      async function uploadFiles(files) {
        if(!files || files.length === 0) return [];
        const formData = new FormData();
        for (const file of files) {
          formData.append('files', file);
        }
        const res = await fetch(API_BASE + '/api/files/upload', {
          method: 'POST',
          headers: { Authorization: 'Basic ' + authToken },
          body: formData,
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Error subiendo archivos');
        }
        return await res.json();
      }

      // Submit new quote request
      formQuoteRequest.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!formQuoteRequest.checkValidity()) {
          formQuoteRequest.classList.add('was-validated');
          return;
        }
        try {
          const uploadedFiles = await uploadFiles(fileInput.files);
          const description = formQuoteRequest.description.value.trim();
          const quantity = Number(formQuoteRequest.quantity.value);
          const measurements = formQuoteRequest.measurements.value.trim();
          const material = formQuoteRequest.material.value.trim();
          const deadline = formQuoteRequest.deadline.value;
          const data = {
            description,
            quantity,
            measurements,
            material,
            deadline,
            files: uploadedFiles,
          };

          const res = await apiFetch('/api/quotes', {
            method: 'POST',
            body: JSON.stringify(data),
          });
          showToast('Solicitud de cotización enviada con éxito.', 'success');
          formQuoteRequest.reset();
          fileListElem.innerHTML = '';
          formQuoteRequest.classList.remove('was-validated');
          loadClientQuotes();
        } catch (err) {
          showToast(err.message, 'error');
        }
      });

      // Load and display client's quotes and orders
      async function loadClientQuotes() {
        try {
          const quotes = await apiFetch('/api/quotes');
          if(quotes.length === 0) {
            clientQuotesContainer.innerHTML = '<div class="alert alert-info">No hay cotizaciones o pedidos.</div>';
            return;
          }
          const listGroup = document.createElement('div');
          listGroup.classList.add('list-group');

          quotes.sort((a,b) => b.createdAt - a.createdAt).forEach((quote) => {
            const item = document.createElement('div');
            item.classList.add('list-group-item', 'mb-2', 'rounded');

            const statusColors = {
              pendiente: 'secondary',
              enviada: 'primary',
              aprobada: 'success',
              rechazada: 'danger',
            };
            const orderStatusColors = {
              pendiente: 'secondary',
              en_produccion: 'warning',
              listo_para_recoger: 'success',
            };

            const quoteStatus = quote.status || 'pendiente';
            const orderStatus = (quote.order && quote.order.status) || null;

            item.innerHTML = \`
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Descripción:</strong> \${quote.description.substring(0, 80)}\${quote.description.length > 80 ? '...' : ''}
                  <br/>
                  <small><strong>Solicitada el:</strong> \${new Date(quote.createdAt).toLocaleDateString('es-ES')}</small>
                </div>
                <div>
                  <span class="badge bg-\${statusColors[quoteStatus] || 'secondary'} badge-status text-uppercase me-2">
                    \${quoteStatus.replace('_',' ')}
                  </span>
                  \${orderStatus ? \`<span class="badge bg-\${orderStatusColors[orderStatus] || 'secondary'} badge-status text-uppercase">Estado Pedido: \${orderStatus.replace('_',' ')}</span>\` : ''}
                </div>
              </div>
              <div class="mt-2">
                \${quoteStatus === 'enviada' ? '<button class="btn btn-sm btn-success me-2" data-action="approve" data-id="' + quote.id + '">Aprobar</button>' : ''}
                \${quoteStatus === 'enviada' ? '<button class="btn btn-sm btn-danger" data-action="reject" data-id="' + quote.id + '">Rechazar</button>' : ''}
                <button class="btn btn-sm btn-outline-primary" data-action="viewDetails" data-id="\${quote.id}">Ver Detalles</button>
              </div>
            \`;

            listGroup.appendChild(item);

            item.querySelectorAll('button').forEach(btn => {
              btn.addEventListener('click', async (e) => {
                const action = e.target.dataset.action;
                const id = e.target.dataset.id;
                if(action === 'approve') {
                  await updateQuoteStatus(id, 'aprobada');
                } else if(action === 'reject') {
                  await updateQuoteStatus(id, 'rechazada');
                } else if(action === 'viewDetails') {
                  await openQuoteDetailModal(id);
                }
              });
            });
          });
          clientQuotesContainer.innerHTML = '';
          clientQuotesContainer.appendChild(listGroup);
        } catch (err) {
          console.error(err);
          clientQuotesContainer.innerHTML = '<div class="alert alert-danger">Error cargando cotizaciones: '+ err.message + '</div>';
        }
      }

      // Update quote status for client approval/rejection
      async function updateQuoteStatus(quoteId, status) {
        try {
          const quote = await apiFetch('/api/quotes/' + encodeURIComponent(quoteId));
          quote.status = status;
          const updateData = { status };
          await apiFetch('/api/quotes/' + encodeURIComponent(quoteId), {
            method: 'PUT',
            body: JSON.stringify(updateData),
          });
          showToast('Cotización ' + status, 'success');
          loadClientQuotes();
        } catch (err) {
          showToast(err.message, 'error');
        }
      }

      // Open quote detail modal with messaging
      async function openQuoteDetailModal(quoteId) {
        try {
          const quote = await apiFetch('/api/quotes/' + encodeURIComponent(quoteId));

          let details = \`
            <p><strong>Descripción:</strong> \${quote.description}</p>
            <p><strong>Cantidad:</strong> \${quote.quantity}</p>
            <p><strong>Medidas:</strong> \${quote.measurements || '-'}</p>
            <p><strong>Material:</strong> \${quote.material || '-'}</p>
            <p><strong>Fecha límite:</strong> \${quote.deadline ? new Date(quote.deadline).toLocaleDateString('es-ES') : '-'}</p>
            <p><strong>Estado:</strong> \${quote.status}</p>
          \`;

          if (quote.files && quote.files.length > 0) {
            details += '<p><strong>Archivos adjuntos:</strong><ul>';
            for (const f of quote.files) {
              details += \`<li><a href="\${API_BASE}/uploads/\${f.filename}" target="_blank" rel="noopener">\${f.originalname}</a></li>\`;
            }
            details += '</ul></p>';
          }

          if(quote.quoteDetails) {
            const qd = quote.quoteDetails;
            const totalPrice = calculateTotal(qd, quote.quantity);
            details += \`
              <hr/>
              <h5>Detalles de la Cotización</h5>
              <p><strong>Descripción:</strong> \${qd.description}</p>
              <p><strong>Precio unitario:</strong> \$\${qd.unitPrice.toFixed(2)}</p>
              <p><strong>Descuento:</strong> \${qd.discount}%</p>
              <p><strong>Impuestos:</strong> \${qd.tax}%</p>
              <p><strong>Total a pagar:</strong> \$\${totalPrice.toFixed(2)}</p>
              <p><strong>Comentarios:</strong> \${qd.comments || '-'}</p>
              \${qd.pdfFile ? \`<p><strong>PDF adjunto:</strong> <a href="\${API_BASE}/uploads/\${qd.pdfFile.filename}" target="_blank" rel="noopener">\${qd.pdfFile.originalname}</a></p>\` : ''}
            \`;
          }

          if(quote.order) {
            details += \`
              <hr/>
              <h5>Estado del Pedido</h5>
              <p><strong>Estado:</strong> \${quote.order.status}</p>
              <p><strong>Responsable:</strong> \${quote.order.responsible || '-'}</p>
              <p><strong>Fecha estimada de finalización:</strong> \${quote.order.estimatedCompletionDate ? new Date(quote.order.estimatedCompletionDate).toLocaleDateString('es-ES') : '-'}</p>
              <p><strong>Información de recogida:</strong> \${quote.order.pickupInfo || '-'}</p>
            \`;
          }

          // Fetch messages
          const messages = await apiFetch('/api/quotes/' + encodeURIComponent(quoteId) + '/messages');

          details += '<hr/><h5>Mensajes</h5>';
          details += '<div id="modalMessages" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 8px; margin-bottom: 15px;">';
          if(messages.length === 0) {
            details += '<em>No hay mensajes.</em>';
          } else {
            for(const m of messages) {
              const sender = m.from === 'client' ? 'Tú' : 'Empresa';
              details += \`
                <div style="margin-bottom:6px;">
                  <strong>\${sender}:</strong> \${m.text} <br/>
                  <small style="color:#666;">\${new Date(m.timestamp).toLocaleString('es-ES')}</small>
                </div>
              \`;
            }
          }
          details += '</div>';
          details += \`
            <form id="modalMessageForm" class="d-flex">
              <input id="modalMsgInput" class="form-control me-2" placeholder="Escribe un mensaje..." required />
              <button class="btn btn-primary" type="submit">Enviar</button>
            </form>
          \`;

          showModal('Detalle Cotización y Pedido', details);

          // Handle message form
          document.getElementById('modalMessageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('modalMsgInput');
            const text = input.value.trim();
            if(!text) return;
            try {
              await apiFetch('/api/quotes/' + encodeURIComponent(quoteId) + '/messages', {
                method: 'POST',
                body: JSON.stringify({ text }),
              });
              showToast('Mensaje enviado');
              input.value = '';
              // Refresh modal content
              document.querySelector('.modal').remove();
              openQuoteDetailModal(quoteId);
            } catch(err) {
              showToast(err.message, 'error');
            }
          });
        } catch (err) {
          showToast(err.message, 'error');
        }
      }

      // Calculate total from quoteDetails and quantity
      function calculateTotal(quoteDetails, quantity) {
        if (!quoteDetails || quantity <= 0) return 0;
        let price = quoteDetails.unitPrice || 0;
        let discount = quoteDetails.discount || 0;
        let tax = quoteDetails.tax || 0;
        let subtotal = price * quantity;
        let discountAmt = (subtotal * discount) / 100;
        let taxedAmt = ((subtotal - discountAmt) * tax) / 100;
        return subtotal - discountAmt + taxedAmt;
      }

      // Show modal helper
      function showModal(title, bodyHTML) {
        // Remove existing
        document.querySelectorAll('.modal').forEach(m => m.remove());
        const modalId = 'modal' + Date.now();
        const modalHTML = \`
          <div class="modal fade show" tabindex="-1" style="display:block; background-color: rgba(0,0,0,0.5);" aria-modal="true" role="dialog" id="\${modalId}">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">\${title}</h5>
                  <button type="button" class="btn-close" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">\${bodyHTML}</div>
              </div>
            </div>
          </div>
        \`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modalElem = document.getElementById(modalId);
        modalElem.querySelector('.btn-close').addEventListener('click', () => {
          modalElem.remove();
        });
        modalElem.addEventListener('click', (e) => {
          if (e.target === modalElem) modalElem.remove();
        });
      }

      // --- Profile management ---
      async function loadProfile() {
        try {
          const profile = await apiFetch('/api/profile');
          profileNameInput.value = profile.name || '';
          profilePhoneInput.value = profile.phone || '';
          profileEmailInput.value = profile.email || '';
          // Also pre-fill contact info on quote request form only if client
          if(currentUser.role === 'client') {
            clientNameInput.value = profile.name || '';
            clientPhoneInput.value = profile.phone || '';
            clientEmailInput.value = profile.email || '';
          }
        } catch(err) {
          showToast('Error cargando perfil: ' + err.message, 'error');
        }
      }

      profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!profileForm.checkValidity()) {
          profileForm.classList.add('was-validated');
          return;
        }
        try {
          const data = {
            name: profileNameInput.value.trim(),
            phone: profilePhoneInput.value.trim(),
          };
          await apiFetch('/api/profile', {
            method: 'PUT',
            body: JSON.stringify(data),
          });
          showToast('Perfil actualizado', 'success');
        } catch(err) {
          showToast('Error actualizando perfil: '+ err.message, 'error');
        }
      });

      // -----------------------------------------------------------------
      // Company side quote management
      // -----------------------------------------------------------------
      async function loadCompanyQuotes() {
        try {
          const quotes = await apiFetch('/api/quotes');
          if(quotes.length === 0) {
            companyQuotesList.innerHTML = '<div class="alert alert-info">No hay solicitudes de cotización.</div>';
            return;
          }
          companyQuotesList.innerHTML = '';
          quotes.sort((a,b) => b.createdAt - a.createdAt).forEach(quote => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.classList.add('list-group-item', 'list-group-item-action');
            const statusClass = {
              pendiete: '',
              pendiente: '',
              enviada: 'list-group-item-primary',
              aprobada: 'list-group-item-success',
              rechazada: 'list-group-item-danger',
            };
            btn.classList.add(statusClass[quote.status]||'');
            btn.textContent = \`[\${quote.status.toUpperCase()}] \${quote.clientId} - \${quote.description.substring(0, 40)}...\`;
            btn.dataset.id = quote.id;
            btn.addEventListener('click', () => openCompanyQuoteDetail(quote.id));
            companyQuotesList.appendChild(btn);
          });
        } catch(err) {
          companyQuotesList.innerHTML = '<div class="alert alert-danger">Error al cargar cotizaciones: '+ err.message + '</div>';
        }
      }

      async function openCompanyQuoteDetail(quoteId) {
        try {
          const quote = await apiFetch('/api/quotes/' + encodeURIComponent(quoteId));
          currentQuoteId = quote.id;
          companyQuotesList.style.display = 'none';
          companyQuoteDetail.style.display = '';
          let attachmentsHTML = '<ul>';
          for(const f of (quote.files || [])) {
            attachmentsHTML += \`<li><a href="\${API_BASE}/uploads/\${f.filename}" target="_blank" rel="noopener">\${f.originalname}</a></li>\`;
          }
          attachmentsHTML += '</ul>';
          quoteDetailContent.innerHTML = \`
            <p><strong>Cliente:</strong> \${quote.clientId}</p>
            <p><strong>Descripción solicitada:</strong> \${quote.description}</p>
            <p><strong>Archivos adjuntos:</strong> \${attachmentsHTML}</p>
            <p><strong>Cantidad:</strong> \${quote.quantity}</p>
            <p><strong>Medidas:</strong> \${quote.measurements || '-'}</p>
            <p><strong>Material:</strong> \${quote.material || '-'}</p>
            <p><strong>Fecha límite:</strong> \${quote.deadline ? new Date(quote.deadline).toLocaleDateString('es-ES') : '-'}</p>
            <p><strong>Estado:</strong> \${quote.status}</p>
          \`;

          // Populate form fields
          formSendQuote.quoteDescription.value = quote.quoteDetails ? quote.quoteDetails.description : '';
          formSendQuote.unitPrice.value = quote.quoteDetails ? quote.quoteDetails.unitPrice : '';
          formSendQuote.discount.value = quote.quoteDetails ? quote.quoteDetails.discount : 0;
          formSendQuote.tax.value = quote.quoteDetails ? quote.quoteDetails.tax : 0;
          formSendQuote.quoteComments.value = quote.quoteDetails ? quote.quoteDetails.comments : '';
          formSendQuote.quoteStatus.value = quote.status;
          formSendQuote.pdfFile.value = '';

          // Load messages
          loadMessages(currentQuoteId);

        } catch(err) {
          showToast('Error cargando detalle: '+ err.message, 'error');
        }
      }

      btnBackToQuotes.addEventListener('click', () => {
        companyQuoteDetail.style.display = 'none';
        companyQuotesList.style.display = '';
        currentQuoteId = null;
      });

      formSendQuote.addEventListener('submit', async e => {
        e.preventDefault();
        if (!formSendQuote.checkValidity()) {
          formSendQuote.classList.add('was-validated');
          return;
        }
        try {
          let pdfFileInfo = null;
          if (formSendQuote.pdfFile.files.length > 0) {
            const pdfUploadData = await uploadFiles(formSendQuote.pdfFile.files);
            pdfFileInfo = pdfUploadData[0];
          }
          const quoteDetails = {
            description: formSendQuote.quoteDescription.value.trim(),
            unitPrice: parseFloat(formSendQuote.unitPrice.value),
            discount: parseFloat(formSendQuote.discount.value),
            tax: parseFloat(formSendQuote.tax.value),
            comments: formSendQuote.quoteComments.value.trim(),
            pdfFile: pdfFileInfo || null,
          };
          const updateData = {
            status: formSendQuote.quoteStatus.value,
            quoteDetails,
          };
          await apiFetch('/api/quotes/' + encodeURIComponent(currentQuoteId), {
            method: 'PUT',
            body: JSON.stringify(updateData),
          });
          showToast('Cotización guardada', 'success');
          companyQuoteDetail.style.display = 'none';
          companyQuotesList.style.display = '';
          loadCompanyQuotes();
        } catch (err) {
          showToast('Error guardando cotización: '+ err.message, 'error');
        }
      });

      async function loadMessages(quoteId) {
        try {
          const messages = await apiFetch('/api/quotes/' + encodeURIComponent(quoteId) + '/messages');
          messagesContainer.innerHTML = '';
          if(messages.length === 0) {
            messagesContainer.innerHTML = '<em>No hay mensajes.</em>';
            return;
          }
          for(const m of messages) {
            const div = document.createElement('div');
            div.classList.add('message', m.from === 'client' ? 'client' : 'company');
            div.textContent = \`\${m.from === 'client' ? 'Cliente: ' : 'Empresa: '}\${m.text} (\${new Date(m.timestamp).toLocaleString('es-ES')})\`;
            messagesContainer.appendChild(div);
          }
        } catch(err) {
          messagesContainer.innerHTML = '<div class="alert alert-danger">Error cargando mensajes</div>';
        }
      }

      formCompanyMessage.addEventListener('submit', async e => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if(!text) return;
        try {
          await apiFetch('/api/quotes/' + encodeURIComponent(currentQuoteId) + '/messages', {
            method: 'POST',
            body: JSON.stringify({ text }),
          });
          messageInput.value = '';
          loadMessages(currentQuoteId);
          showToast('Mensaje enviado', 'success');
        } catch(err) {
          showToast('Error enviando mensaje: '+ err.message, 'error');
        }
      });

      // --- Company orders ---
      async function loadCompanyOrders() {
        try {
          const orders = await apiFetch('/api/orders');
          if(orders.length === 0) {
            companyOrdersList.innerHTML = '<div class="alert alert-info">No hay pedidos aprobados.</div>';
            return;
          }
          companyOrdersList.innerHTML = '';
          orders.sort((a,b) => b.order.createdAt - a.order.createdAt).forEach(orderEntry => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.classList.add('list-group-item', 'list-group-item-action');
            const statusColors = {
              pendiente: 'secondary',
              en_produccion: 'warning',
              listo_para_recoger: 'success',
            };
            btn.classList.add('list-group-item-' + (statusColors[orderEntry.order.status] || 'secondary'));
            btn.textContent = \`[\${orderEntry.order.status.toUpperCase()}] \${orderEntry.clientName} - \${orderEntry.description.substring(0,40)}...\`;
            btn.dataset.id = orderEntry.quoteId;
            btn.addEventListener('click', () => openCompanyOrderDetail(orderEntry.quoteId));
            companyOrdersList.appendChild(btn);
          });
        } catch(err) {
          companyOrdersList.innerHTML = '<div class="alert alert-danger">Error al cargar pedidos: '+ err.message + '</div>';
        }
      }

      async function openCompanyOrderDetail(quoteId) {
        try {
          const quote = await apiFetch('/api/quotes/' + encodeURIComponent(quoteId));
          currentOrderQuoteId = quote.id;
          companyOrdersList.style.display = 'none';
          companyOrderDetail.style.display = '';

          orderDetailContent.innerHTML = \`
            <p><strong>Cliente:</strong> \${quote.clientId}</p>
            <p><strong>Descripción:</strong> \${quote.description}</p>
            <p><strong>Estado actual:</strong> \${quote.order.status}</p>
            <p><strong>Responsable:</strong> \${quote.order.responsible || '-'}</p>
            <p><strong>Fecha estimada de finalización:</strong> \${quote.order.estimatedCompletionDate ? new Date(quote.order.estimatedCompletionDate).toLocaleDateString('es-ES') : '-'}</p>
            <p><strong>Información de recogida:</strong> \${quote.order.pickupInfo || '-'}</p>
          \`;

          formUpdateOrder.orderStatus.value = quote.order.status;
          formUpdateOrder.responsible.value = quote.order.responsible || '';
        } catch(err) {
          showToast('Error cargando detalle pedido: ' + err.message, 'error');
        }
      }

      formUpdateOrder.addEventListener('submit', async e => {
        e.preventDefault();
        if(!formUpdateOrder.checkValidity()) {
          formUpdateOrder.classList.add('was-validated');
          return;
        }
        try {
          const updateData = {
            status: formUpdateOrder.orderStatus.value,
            responsible: formUpdateOrder.responsible.value.trim(),
          };
          await apiFetch('/api/orders/' + encodeURIComponent(currentOrderQuoteId),{
            method: 'PUT',
            body: JSON.stringify(updateData)
          });
          showToast('Pedido actualizado', 'success');
          companyOrderDetail.style.display = 'none';
          companyOrdersList.style.display = '';
          loadCompanyOrders();
        } catch(err) {
          showToast('Error actualizando pedido: ' + err.message, 'error');
        }
      });

      btnBackToOrders.addEventListener('click', () => {
        companyOrderDetail.style.display = 'none';
        companyOrdersList.style.display = '';
        currentOrderQuoteId = null;
      });

      // On page load check for saved token and user
      window.addEventListener('load', () => {
        try {
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user'));
          if(token && user) {
            authToken = token;
            currentUser = user;
            setAuth(token, user);
          } else {
            setAuth(null, null);
          }
        } catch {
          setAuth(null, null);
        }
      });

      // Save token & user on login state
      function setAuth(token, user) {
        if(token && user) {
          localStorage.setItem('token', token);
          localStorage.setItem('user', JSON.stringify(user));
        } else {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
        }
        authToken = token;
        currentUser = user;
        if(token && user) {
          loginContainer.style.display = 'none';
          appContainer.style.display = '';
          updateUIByRole();
          loadProfile();
          if(user.role === 'client') {
            loadClientQuotes();
          } else if (user.role === 'company') {
            loadCompanyQuotes();
            loadCompanyOrders();
          }
        } else {
          loginContainer.style.display = '';
          appContainer.style.display = 'none';
        }
      }
    })();
  </script>
</body>
</html>